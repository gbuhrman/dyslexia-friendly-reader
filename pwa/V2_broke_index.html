<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dyslexia-Friendly Reader</title>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="reader.css">
  <script src="vendor/epub/epub.min.js" defer></script>
  <script src="reader.js" defer></script> <!-- Core functionality (read-aloud, bookmarks, etc.) -->
</head>
<body>
  <div id="controls">
    <label>Font: 
      <select id="fontSelect">
        <option value="OpenDyslexic, Arial, sans-serif">OpenDyslexic</option>
        <option value="Arial, sans-serif">Arial</option>
        <option value="Verdana, sans-serif">Verdana</option>
      </select>
    </label>
    <button id="testVoiceBtn" type="button">Test Voice</button>
    <p id="testVoiceSample" style="margin:0;padding:0;font-size:0.9em;color:#555;">Sample: "The quick brown fox jumps over the lazy dog."</p>
    <label>Size: <input type="range" id="fontSize" min="14" max="28" value="18"></label>
    <label>Line Spacing: <input type="range" id="lineSpacing" min="1" max="2.5" step="0.1" value="1.6"></label>
    <label>Text Color: <input type="color" id="textColor" value="#000000"></label>
    <label>Background: <input type="color" id="bgColor" value="#f8f8f8"></label>
    <label>Upload: <input type="file" id="fileInput" accept=".txt"></label>
    <label><input type="checkbox" id="autoformatToggle" checked> Autoformat readability</label>
    <label><input type="checkbox" id="clickReadToggle"> Click-to-Read Mode</label>
    <label>Reading Speed: <input type="range" id="speedControl" min="0.5" max="2.5" step="0.1" value="1"></label>
    <label>Voice: 
      <select id="voiceSelect" aria-label="Voice selection">
        <option value="">Loading voices…</option>
      </select>
    </label>
    <button id="readAloudBtn">Read Aloud from Bookmark</button>
    <button id="stopReadAloudBtn">Stop</button>
    <label>Chapter: <select id="chapterSelect"><option value="">--Select--</option></select></label>
    <button id="bookmarkBtn">Bookmark</button>
    <button id="gotoBookmarkBtn">Go to Bookmark</button>
  </div>

  <div id="content" role="main" aria-live="polite">
    <section id="voiceTest" class="voice-test" aria-label="Voice test area">
      <p id="voiceTestText" contenteditable="true">
        This is a short test paragraph to audition the selected voice. 
        You can edit this text or select any text on the page and click “Speak selection”.
      </p>
      <button id="speakSelectionBtn">Speak selection</button>
    </section>

    <h1>Dyslexia-Friendly Reader</h1>
    <section id="epubPanel" hidden aria-label="EPUB Reader">
      <div class="epub-controls">
        <button id="epubPrevBtn" aria-label="Previous page">Prev</button>
        <button id="epubNextBtn" aria-label="Next page">Next</button>
        <label>EPUB Font Size: <input type="range" id="epubFontSize" min="80" max="180" step="10" value="100"></label>
        <button id="epubSpeakBtn">Speak current page</button>
        <button id="epubCloseBtn">Close EPUB</button>
      </div>
      <div id="epub-viewer" style="width:100%;height:70vh;border:1px solid #ddd;border-radius:10px;background:#fff;"></div>
    </section>

    <h2>Upload Your Own Text to use Read Aloud Features</h2>
    <div id="story">
      <!-- Story content will be dynamically loaded -->
    </div>

    <div id="definitionPopup" role="status" aria-live="polite"></div>
    
    <!-- Library Panel (new) -->
    <section id="libraryPanel" aria-label="Library and OPDS" style="margin-top:1rem;">
      <h2>Library</h2>
      <div class="lib-controls" style="display:flex;gap:.5rem;flex-wrap:wrap;margin:.5rem 0;">
        <input id="libSearch" type="search" placeholder="Search title or author" aria-label="Search">
        <select id="libGenreFilter" aria-label="Filter by genre">
          <option value="">All genres</option>
        </select>
        <select id="libSort" aria-label="Sort by">
          <option value="title">Sort: Title</option>
          <option value="author">Sort: Author</option>
          <option value="fk">Sort: FK Grade</option>
          <option value="df">Sort: DF Score</option>
        </select>
        <button id="libRefreshBtn" type="button">Refresh</button>
      </div>

      <div class="opds-controls" style="display:flex;gap:.5rem;flex-wrap:wrap;margin:.5rem 0;">
        <select id="opdsSourceSelect" aria-label="OPDS source">
          <option value="./opds/index.json" selected>Local OPDS (bundled)</option>
        </select>
        <input id="opdsCustomUrl" type="url" placeholder="https://example.com/opds/index.json" aria-label="Custom OPDS URL" style="min-width:20rem;">
        <button id="opdsLoadBtn" type="button">Load OPDS</button>
      </div>

      <div id="libStatus" style="margin:.25rem 0;"></div>
      <ul id="libList" style="list-style:none;padding:0;margin:0;display:grid;gap:.5rem;"></ul>
    </section>
  </div>

  <footer>Powered by Howard Forge Press</footer>

  <!-- Load reader.js (existing functionality) -->
  <script src="reader.js" defer></script>

  <!-- Load reader_library.js (new library handling functionality) -->
  <script src="reader_library.js" defer></script>
</body>
</html>




